# 「浅」谈认证授权

> 简介：用户登陆有两个阶段：认证和授权。
认证：指的是当前用户的身份，当用户登陆过后，系统便能追踪到他的身份作出符合相应的业务逻辑的操作。即是用户没有登陆，大多数系统也能追踪到他的身份，只是当作来宾或者匿名用户来处理。认证技术解决的是“我是谁”的问题

授权：指的是什么样的身份被允许访问某些资源，在获取到用户身份后继续检查用户的权限。来解决用户能访问什么样的资源。

> 需求：为了保证接口调用的安全性，只有经过认证的系统才能调用我们的接口，没有认证的接口会被拒绝。

## 传统的认证措施
通过用户名和密码来做认证。我们允许访问我们服务的调用放，派发一个应用名和一个对应的密码。调用方每次进行接口与请求的时候，都携带自己的APPid和密码，服务端接受到接口调用请求之后，解析出用户名和密码，并与存储在服务端的appid和密码进行比对。如果一致，则说明认证成功，否则拒绝请求。

话不多说，上代码：


这样验证，有一个明显的缺点：每次都是明文传输密码，很容易被中间人截获，因此，我们在此基础上做一些改进，使用加密算法，对密码进行加密再传输到服务端进行验证。

「重放攻击」

以上做法仍然会被中间人截获，黑客携带该密码仍然可以请求其他资源。

## oauth策略
针对上文提出的传统的认证策略，oauth提出了新的解决策略，调用方将请求接口的URL和APPID、密码拼接在一起，然后进行加密，生成一个token。调用方在进行接口请求的时候，将这个token及appid，随url一块传递给服务端。服务端接受到这些数据之后，根据appid从数据库中取出相应的密码，并通过同样的token生成算法，生成另一个token。用这个新生成的token和调用方传递来的token对比。如果一致，则允许接口调用请求，否则，拒绝接口调用。

具体流程如下：
1. 生成token
2. 生成新的url
3. 请求服务端
4. 服务端解析出url，appid，token
5. 从数据库中取出数据进行对比
6. 生成token
7. 比对服务端token和客户端token


上述这种设计由于token生成是固定的，所以仍然不安全，被截获后，仍然可以被认证。那么就对生成token的算法进行优化，生成token加入时间戳，调用方在进行接口请求的时候，将token，appid，时间戳，一起传给服务端。

服务端接受到这些数据之后，会验证时间戳，验证一定时间内的token是否过期。

流程如下：
1. 生成token
2. 生成url
3. 请求服务端
4. 服务端解析url，appid，token，ts
5. 验证token是否失效
5. 从数据库中取出数据验证
7. 生成服务端token
8. 校验服务端token和客户端token

## 