<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <link rel="icon" href="static/img/myicon.ico">
    <!-- 引入 Bootstrap -->
    <link href="static/Bootstrap/bootstrap-3.3.7-dist/css/bootstrap.min.css" rel="stylesheet" />
    <!-- jQuery (Bootstrap 的 JavaScript 插件需要引入 jQuery) -->
    <script type="text/javascript" src="static/js/jquery-3.3.1.min.js"></script>
    <!-- 包括所有已编译的插件 -->
    <script type="text/javascript" src="static/Bootstrap/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script>
    <title>BugReport</title>
</head>
<body >

<!--头部导航栏-->
<nav class="navbar navbar-default" role="navigation">
    <div class="container-fluid">
        <div class="navbar-header">
            <img src="static/img/iauto_LOGO.png" alt="LOGO" width="280px">
        </div>
        <div>
            <ul class="nav navbar-nav">
                <li class="active"><a href="index"><span class="glyphicon glyphicon-file"></span> Info</a></li>
                <li><a href="mailInfo"><span class="glyphicon glyphicon-envelope"></span> Mail</a></li>
            </ul>
        </div>
        <div>
            <ul class="nav navbar-nav navbar-right">
                <li><a> <span id="Timer"></span></a></li>
                <li><a><span>hi miguosi</span></a></li>
                <li><a href="#"><span class="glyphicon glyphicon-log-out"></span> 注销</a></li>
            </ul>
        </div>
    </div>
</nav>

<!--mainInfo-->
<div class="container-fluid">

    <!--左侧栏-->
    <div class="col-lg-2 col-lg-pull-0">

        <!--详情导航栏-->
        <div  style="border-bottom: 1px solid darkgrey;margin-bottom: 20px">
            <h3>详细信息</h3>
        </div>
        <ul id="myTab" class="nav  nav-pills nav-stacked">
            <li class="active">
                <a href="#log" data-toggle="pill">日志</a>
            </li>
            <li id="imgLi">
                <a href="#img" data-toggle="pill" id="imgPill" >图片</a>
            </li>
            <li id="vidLi">
                <a href="#vid" data-toggle="pill" id="vidPill">视频</a>
            </li>
        </ul>

        <!--详情介绍栏-->
        <div style="border-top: darkgrey solid 1px;border-bottom: darkgrey solid 1px;height: 480px;margin-top: 10px">
            <table class="table" style="width: 280px">
                <caption>基本信息</caption>
                <tbody>
                <tr>
                    <td>Report ID:</td>
                    <td id="reportId"> </td>
                </tr>
                <tr>
                    <td>Device ID:</td>
                    <td id="deviceId"></td>
                </tr>
                <tr>
                    <td>Received Time：</td>
                    <td id="receiptTime"></td>
                </tr>
                <tr>
                    <td>Subtype:</td>
                    <td id="subtype"></td>
                </tr>
                <tr>
                    <td>Vendor:</td>
                    <td id="vendorName"></td>
                </tr>
                <tr>
                    <td>Project:</td>
                    <td id="projectName"></td>
                </tr>
                <tr>
                    <td>Platform:</td>
                    <td id="platform"></td>
                </tr>
                <tr>
                    <td>Code Version：</td>
                    <td id="codeVersion"></td>
                </tr>
                <tr>
                    <td>Detail Version：</td>
                    <td id="detailVersion"></td>
                </tr>
                <tr>
                    <td>Release:</td>
                    <td id="release"></td>
                </tr>
                <tr>
                    <td>Signature:</td>
                    <td id="signature"></td>
                </tr>
                </tbody>
            </table>
        </div>

        <!--下载栏-->
        <div>
            <br>
            <br>
            <span class="glyphicon glyphicon-download"></span> 下载:
            <a href="#" id="downLoad"></a>
        </div>
    </div>

    <!--右侧栏-->
    <div class="col-lg-10">
        <div id="myTabContent" class="tab-content" style=" border-left: 1px solid darkgrey;width: 1500px;height: 880px;padding: 20px">

            <!--log切换页面-->
            <div class="tab-pane fade in active" id="log">
                <div class="row">
                    <div class="col-lg-8">
                        <div class="panel panel-default" style="height: 850px">
                            <div class="panel-heading">
                                <h3 class="panel-title" id="logTitle">
                                </h3>
                            </div>
                            <div class="panel-body" id="logInfo" style="width: 100%;height: 800px">
                                <div style="width: 100%;height: 100%;overflow-y:scroll;word-wrap:break-word" id="displayTxt">

                                    <div id="content"></div>

                                </div>
                            </div>
                        </div>
                    </div>
                    <div class="col-lg-4">
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">
                                    日志列表
                                </h3>
                            </div>
                            <div class="panel-body" style="height: 150px;width: 100%;overflow-y: auto" id="logList">
                            </div>
                        </div>
                        <div class="panel panel-default">
                            <div class="panel-heading">
                                <h3 class="panel-title">
                                    <div class="input-group">
					                    <span class="input-group-addon">
                                            <span class=" glyphicon glyphicon-search"></span>
                                        </span>
                                        <input type="text" class="form-control" placeholder="请输入搜索内容" id="search">
                                    </div><!-- /input-group -->
                                </h3>
                            </div>
                            <div class="panel-body" style="height: 582px;width: 464px;word-wrap:break-word;overflow-y: scroll">
                                <div id="searchR">

                                </div>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--img切换页面-->
            <div class="tab-pane fade" id="img" style="width: 1280px;height: 720px">
                <div class="text-center">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                图片列表
                            </h3>
                        </div>
                        <div class="panel-body">
                            <div id="myCarousel" class="carousel slide">
                                <!-- 轮播（Carousel）指标 -->
                                <ol class="carousel-indicators" id="olList">
                                </ol>
                                <!-- 轮播（Carousel）项目 -->
                                <div class="carousel-inner" id="divList">
                                </div>
                                <!-- 轮播（Carousel）导航 -->
                                <a class="left carousel-control" href="#myCarousel" role="button" data-slide="prev">
                                    <span class="glyphicon glyphicon-chevron-left" aria-hidden="true"></span>
                                    <span class="sr-only">Previous</span>
                                </a>
                                <a class="right carousel-control" href="#myCarousel" role="button" data-slide="next">
                                    <span class="glyphicon glyphicon-chevron-right" aria-hidden="true"></span>
                                    <span class="sr-only">Next</span>
                                </a>
                            </div>
                        </div>
                    </div>
                </div>
            </div>

            <!--video切换页面-->
            <div class="tab-pane fade" id="vid"  style="width: 1425px; height: 720px">
                <div class="text-center">
                    <div class="panel panel-default">
                        <div class="panel-heading">
                            <h3 class="panel-title">
                                <select class="form-control center-block" style="width: 300px" id="videoList">
                                </select>
                            </h3>
                        </div>
                        <div class="panel-body">
                            <video controls="controls" preload='metadata' id="video" src=""></video>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<div>

</div>
</body>

<!--时间显示-->
<script type="text/javascript">
    $(function () {
        setInterval("GetTime()", 10);
    });
    //获取时间并设置格式
    function GetTime() {
        var  now, hour, min, sec;
        now = new Date();
        hour = now.getHours();
        min = now.getMinutes();
        sec = now.getSeconds();
        if (hour < 10) {
            hour = "0" + hour;
        }
        if (min < 10) {
            min = "0" + min;
        }
        if (sec < 10) {
            sec = "0" + sec;
        }
        $("#Timer").html(
            now.getFullYear() + "年" + (now.getMonth() + 1) + "月" + now.getDate() + "日" + "  " + hour + ":" + min + ":" + sec
        );
    }
</script>
<script>
    //截取文件名
    function interceptName(res) {
        var start = res.lastIndexOf('/') + 1;
        var end = res.length ;
        var name = res.slice(start,end);
        return name;
    }
</script>


<script>

     //获取 url 地址传递参数reportId
     function GetQueryString(name) {
        var reg = new RegExp("(^|&)" + name + "=([^&]*)(&|$)","i");
        var r = window.location.search.substr(1).match(reg);
        if (r!=null) return (r[2]); return null;
    }
    //定义全局变量reportId，判断是从index页面进入还是邮件连接进入detail页面，据此赋值不同的值
     var reportId;
     //从邮件链接获取reportId值
    if(GetQueryString("reportId")!=null){
    console.log(reportId);
    reportId = GetQueryString("reportId");}
    else{
    alter("null");
    }
    // 定义全局变量接收日志返回值
    var arr = [];
    $.ajax({
            type: "GET",
            url: "/bugreport/getReportDetails",
            contentType: "application/json",
            dataType: "json",
            async:true,
            data: {"reportId":reportId},
            //接收后台返回的 report 详情信息数据，赋值给全局变量
            success: function (data) {
                detailInfo = data.data;
                var time = detailInfo.receivedTime;
                var subtype = detailInfo.subtype;
                var vendor = detailInfo.vendorName;
                var project = detailInfo.projectName;
                var platform = detailInfo.platform;
                var code = detailInfo.codeVersion;
                var detail = detailInfo.detailVersion;
                var release = detailInfo.releaseVersion;
                var sign = detailInfo.signature;
                var device = detailInfo.deviceId;
                var loglist=detailInfo.log;
                var filePath = detailInfo.fileName;
                var imglist = detailInfo.image;
                var videolist = detailInfo.video;
                var loglist=detailInfo.log;

                // 显示基本信息
                document.getElementById('reportId').innerText = reportId;
                document.getElementById('receiptTime').innerText = time;
                document.getElementById('subtype').innerText = subtype;
                document.getElementById('vendorName').innerText = vendor;
                document.getElementById('projectName').innerText = project;
                document.getElementById('platform').innerText = platform;
                document.getElementById('codeVersion').innerText = code;
                document.getElementById('detailVersion').innerText = detail;
                document.getElementById('release').innerText = release;
                document.getElementById('signature').innerText = sign;
                document.getElementById('deviceId').innerText = device;
                document.getElementById('downLoad').href = "/bugreport/downloadSingle?fileName="+detailInfo.fileName;
                document.getElementById('downLoad').innerText = detailInfo.fileName;


                // 显示日志列表信息
                var div = document.getElementById('logList');

                for (var i=loglist.length;i>0;i--){
                    var p = document.createElement("p");
                    var a = document.createElement("a");
                    div.appendChild(p);
                    p.appendChild(a);
                    a.setAttribute("id",i);
                    a.setAttribute("href","javascript:void(0)");
                    a.setAttribute("name",loglist[loglist.length-i]);
                    a.setAttribute("onclick","changeLog(this)");
                    a.innerHTML = interceptName(loglist[loglist.length-i]);
                    }

                var o = document.getElementById(loglist.length);
                changeLog(o);
                // 显示图片信息
                // 判断是否存在图片
                if (imglist == ""){
                    document.getElementById("imgPill").removeAttribute('data-toggle');
                    document.getElementById("imgLi").setAttribute('class','disabled');
                }
                else {
                    var ollist = document.getElementById('olList');
                    var divlist = document.getElementById('divList');
                    var sum = 0;
                    for (var j = imglist.length;j>0;j--){
                        var li = document.createElement("li");
                        ollist.appendChild(li);
                        li.setAttribute("data-target","#myCarousel");
                        li.setAttribute("data-slide-to",sum);
                        if (sum == 0){
                            li.setAttribute("class","active");
                        }
                        var div1 = document.createElement("div");
                        var div2 = document.createElement("div");
                        var img = document.createElement("img");
                        divlist.appendChild(div1);
                        div1.appendChild(img);
                        div1.appendChild(div2);
                        if(sum == 0){
                            div1.setAttribute("class","item active");
                        }else {
                            div1.setAttribute("class","item");
                        }
                        img.setAttribute("src",imglist[sum]);
                        div2.setAttribute("class","carousel-caption");
                        div2.innerText = "图片"+(sum+1);

                        sum++;
        }
                }
                // 显示视频信息
                // 判断是否存在视频
                if (videolist == ""){
                    document.getElementById("vidPill").removeAttribute('data-toggle');
                    document.getElementById("vidLi").setAttribute('class','disabled');
                } else {
                    var vid = document.getElementById('videoList');
                    var sum1 = 0;
                    document.getElementById('video').src = videolist[sum1];
                    for (var a = videolist.length;a>0;a--){
                        var op = document.createElement('option');
                        vid.appendChild(op);
                        op.value = videolist[sum1];

                        op.innerText = "视频"+(sum1+1);
                        sum1++;
                    }
                }



                 }
        });
</script>
<!-- 读取显示日志内容 -->
<script type="text/javascript">

    var currIndex = 0;
    function loadAll(response){
        //将数据分组，每组1000条
        var groups = group(response);
        for (var i = 0; i < groups.length; i++) {
        //闭包， 保持i值的正确性
        window.setTimeout(function () {
            var group = groups[i];
            var index = i + 1;
            return function () {
                //分批渲染,
                loadPart( group, index );
                console.log(index);
            }
        }(), 10);
    }

    }
    //数据分组函数
    function group(data){
        var result = [];
        var groupItem;
        for(var i = 0; i<data.length;i++){
            if(i % 1000 == 0){
                groupItem != null && result.push(groupItem);
                groupItem = [];
            }
            groupItem.push(data[i]);
        }
        result.push(groupItem);
        return result;
    }


    // 加载某一组数据
    function loadPart(group, index){
        var html = "";
        for(var i = 0;i<group.length;i++){
            var item = group[i];
           var num = i+(index-1)*1000;
          html += "<span id="+num+">"+item+"</span>"+"<br>";

        }
        // 保证数据不乱
        while(index - currIndex == 1){
            $("#content").append(html);
            currIndex = index;
        }
     }




    function changeLog(obj){

        // 从链接中获取路径
        var path = $(obj).attr('name');
        
        console.log("1:"+currIndex);
        //根据log文件路径获取文件内容
        $.ajax({
            type: "GET",
            url: "/bugreport/getLogContent",
            contentType: "application/json",
            dataType: "json",
            async:true,
            data: {"logPath":path},
            //接收后台返回的report详情信息数据，赋值给全局变量
            success: function (data) {
                // 将data 存储在arr中，便于后面检索时候用到
                arr = data;
                $('#content').empty();
                document.getElementById('logTitle').innerText = interceptName(path);
                
                currIndex = 0;  
                loadAll(data);
                console.log("2:"+currIndex);
                //执行点击事件同时清空搜索框
                $('#search').val('');
                $('#searchR').empty();

            }
        });
    }





</script>
<script type="text/javascript">

</script>
<!--图片关闭自动切换-->
<script>
        $('#myCarousel').carousel({
        interval: false
        })
</script>

<!--视频关闭自动切换-->
<script>
        $('#videoList').change(function () {
        var videoRes = $("#videoList").val();
        document.getElementById('video').src = videoRes;
        })
</script>
<!-- 文本检索 -->
<script>

        // 1.搜索功能,暂时采用遍历形式，后面具体优化搜索效率
        function getResultsByKeyWord(keyword){
            var result = [];  //用来接收搜索结果,需要保存原始数组的索引和值,list里存储map类型

            for (var i in arr){
               var map = new Map();
               if(isSearchVal(arr[i],keyword)){//匹配成功
                    map.set(i,arr[i]);
                    result.push(map);

               }
            }
         return result;
        }
         // 通过正则匹配，判断是否为搜索结果
        function isSearchVal(str,keyword){
            var regex =new RegExp(keyword,"igm"); // 忽略大小写并支持多行匹配和全局匹配
            return regex.test(str);
        }

    var currIndex = 0;
    function loadSearch(response){
        //将数据分组，每组1000条
        var groups = group(response);
        for (var i = 0; i < groups.length; i++) {
        //闭包， 保持i值的正确性
        window.setTimeout(function () {
            var group = groups[i];
            var index = i + 1;
            return function () {
                //分批渲染,
                loadSearchPart( group, index );
                console.log(index);
            }
        }(), 10);
    }

    }
    var oldId = -1;
    function changeCol(id){
            if(oldId>=0){
                 // 先恢复颜色
                document.getElementById(''+oldId+'').setAttribute('style','');
            }

            // 对当前点击高亮
            document.getElementById(''+id+'').setAttribute('style','background-color:lightskyblue;');
            oldId=id;

        }
    // 加载某一组数据并渲染
    function loadSearchPart(group, index){

        for(var i in group){

            var id = group[i].keys().next().value;// 获取map的第一个key的值
            var item = group[i].get(id);

            //item = item.replaceAll(keyword,'<font style="background-color:yellow;">$1</font>');  // 添加高亮
            var num = i+(index-1)*1000;
            var div = document.getElementById('searchR');
            var a = document.createElement('a');
            var hr = document.createElement('hr');
            div.appendChild(a);
            a.innerHTML = item;
            a.setAttribute('href','#'+id);
            a.setAttribute('onclick','changeCol('+id+')');
            div.appendChild(hr);
        }
        // 保证数据不乱
        while(index - currIndex == 1){
            $("#searchR").append(html);
            currIndex = index;
        }
     }

        // 2.添加搜索结果的dom节点具体数据
        function printSearchDom(keyword,result){
            console.log("r"+result);
            // 将搜索到的值打印在检索框内
            if (result==''){

                var div = document.getElementById('searchR');
                var span = document.createElement('span');
                div.appendChild(span);
                span.innerHTML = "没有找到关于 <b>"+keyword+"</b> 搜索结果";
            } else {
                // 执行延迟加载，避免数据过大，加载速度慢导致用户体验不高
                loadSearch(result);
            }

        }
        // 3. 点击对应链接后通过锚点对应日志内容并高亮显示



        // replaceAll替换函数
        String.prototype.replaceAll = function(a,b){
            return this.replace(new RegExp("("+a+")",'gm'),b);
        };

        function search(){

            var keyword = document.getElementById('search').value;
            $('#searchR').empty();
            var result = getResultsByKeyWord(keyword);
           
            printSearchDom(keyword,result);


        }
 
        // 动态检索调用
        $('#search').change(function () {
            search();
        });

        // 回车检索
        $(document).ready(function(){
            $("#search").keydown(function(event){
                if (event.which == '13'){
                    search();
                }
            });
        });
    </script>

</html>